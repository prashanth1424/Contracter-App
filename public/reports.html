<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices | TrustGig</title>
    <style>
        :root { --primary: #1e3a8a; --sidebar: #0f172a; --bg: #f8fafc; --text: #334155; --accent: #3b82f6; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--sidebar); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid #1e293b; }
        .nav-links { flex: 1; padding: 20px 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-link { padding: 12px 25px; color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 15px; font-weight: 500; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: var(--primary); color: white; border-left: 4px solid var(--accent); }
        
        /* MAIN */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; }
        .header h1 { margin: 0 0 5px 0; color: #0f172a; font-size: 2rem; }
        .header p { margin: 0 0 30px 0; color: #64748b; }

        /* BUILDER CARD */
        .builder-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .filter-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        label { display: block; font-weight: bold; color: #475569; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f8fafc; font-size: 1rem; outline: none; }
        
        .btn-gen { width: 100%; padding: 14px; background: #0f172a; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-gen:hover { background: #334155; }

        /* RESULTS AREA */
        #result-area { display: none; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .result-header { background: #f8fafc; padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .total-box { font-size: 1.5rem; font-weight: bold; color: #10b981; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px 20px; text-align: left; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; color: #1e293b; }

        /* ACTIONS */
        .action-row { padding: 20px; background: white; display: flex; gap: 15px; }
        .btn-link { flex: 1; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: none; }
        .btn-link:hover { background: #059669; }

        /* SECURE LINK BOX */
        #share-area { display: none; padding: 20px; background: #ecfdf5; border-top: 1px dashed #a7f3d0; text-align: center; }
        .link-badge { background: #d1fae5; color: #065f46; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; display: inline-block; }
        .link-text { display: block; font-family: monospace; font-size: 1rem; color: #047857; margin-bottom: 15px; word-break: break-all; background: white; padding: 10px; border-radius: 6px; border: 1px solid #a7f3d0; }
        .btn-wa { background: #25D366; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
    <script>if (sessionStorage.getItem('role') !== 'owner') window.location.href = 'login.html';</script>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">üõ°Ô∏è TrustGig</div>
        <nav class="nav-links">
            <a href="index.html" class="nav-link">üìä Dashboard</a>
            <a href="owner_inbox.html" class="nav-link">üì´ Photo Inbox</a>
            <a href="reports.html" class="nav-link active">üßæ Invoices & Links</a>
            <a href="clients.html" class="nav-link">üè¢ Manage Clients</a>
            <a href="add_worker.html" class="nav-link">üë∑ Add Worker</a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1>Invoice Generator</h1>
            <p>Compile escrow-verified work and generate secure payment links.</p>
        </div>

        <div class="builder-card">
            <div class="filter-row">
                <div>
                    <label>Select Client</label>
                    <select id="client-select"><option value="">-- Choose Client --</option></select>
                </div>
                <div>
                    <label>Start Date</label>
                    <input type="date" id="start-date">
                </div>
                <div>
                    <label>End Date</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            <button class="btn-gen" onclick="generateReport()">Scan & Compile Ledger</button>
        </div>

        <div id="result-area">
            <div class="result-header">
                <div><strong style="color:#0f172a; font-size:1.1rem;">Compiled Ledger</strong></div>
                <div class="total-box">‚Çπ<span id="screen-total">0</span></div>
            </div>
            
            <table>
                <thead><tr><th>Worker</th><th>Date</th><th>Task Verified</th><th>Amount</th></tr></thead>
                <tbody id="screen-list"></tbody>
            </table>

            <div class="action-row">
                <button id="link-btn" class="btn-link" onclick="createShareLink()">üîó Generate Secure Payment Link</button>
            </div>

            <div id="share-area">
                <div class="link-badge">Escrow Link Created</div>
                <span class="link-text" id="final-link">...</span>
                <button class="btn-wa" onclick="window.openWhatsApp()">Share on WhatsApp üí¨</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { db, collection, getDocs, addDoc } from './db.js';

        let currentInvoiceData = null;

        window.onload = async function() {
            const select = document.getElementById('client-select');
            const snap = await getDocs(collection(db, "clients"));
            snap.forEach(doc => { select.innerHTML += `<option value="${doc.data().name}">${doc.data().name}</option>`; });
        };

        window.generateReport = async function() {
            const clientName = document.getElementById('client-select').value;
            const startVal = document.getElementById('start-date').value;
            const endVal = document.getElementById('end-date').value;

            if(!clientName || !startVal || !endVal) return alert("Select all fields!");

            const startDate = new Date(startVal); startDate.setHours(0,0,0,0);
            const endDate = new Date(endVal); endDate.setHours(23,59,59,999);

            let grandTotal = 0; let items = []; 
            const screenList = document.getElementById('screen-list');
            screenList.innerHTML = '';

            const workersSnap = await getDocs(collection(db, "workers"));
            workersSnap.forEach(doc => {
                const worker = doc.data();
                (worker.history || []).forEach(log => {
                    if (log.company === clientName) {
                        const logDate = new Date(log.date);
                        if (logDate >= startDate && logDate <= endDate) {
                            grandTotal += Number(log.amount);
                            items.push({ worker: worker.name, date: log.date.split(',')[0], desc: log.codes, amount: log.amount, photo: log.imageUrl || log.photoUrl || log.photo || null });
                            
                            const photoIcon = (log.imageUrl || log.photoUrl || log.photo) ? "üì∏ " : "";
                            screenList.innerHTML += `<tr><td>${worker.name}</td><td>${log.date.split(',')[0]}</td><td>${photoIcon}${log.codes}</td><td style="font-weight:bold;">‚Çπ${log.amount}</td></tr>`;
                        }
                    }
                });
            });

            document.getElementById('screen-total').innerText = grandTotal;
            currentInvoiceData = { clientName, total: grandTotal, items, createdAt: new Date().toLocaleString(), status: "pending" };

            document.getElementById('result-area').style.display = 'block';
            document.getElementById('link-btn').style.display = 'block'; 
            document.getElementById('share-area').style.display = 'none'; // reset
        }

        window.createShareLink = async function() {
            if (!currentInvoiceData) return;
            const btn = document.getElementById('link-btn');
            btn.innerText = "‚è≥ Encrypting & Saving...";
            try {
                const docRef = await addDoc(collection(db, "invoices"), currentInvoiceData);
                document.getElementById('final-link').innerText = `${window.location.origin}/bill.html?id=${docRef.id}`;
                document.getElementById('share-area').style.display = 'block';
                btn.style.display = 'none'; // Hide button after creating
            } catch (e) { alert("Error: " + e.message); }
        }

        window.openWhatsApp = function() {
            const link = document.getElementById('final-link').innerText;
            const msg = `Hello! Here is your secure TrustGig invoice. Please view work proof and approve payment here: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>