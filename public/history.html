<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker History</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #1f2937; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #6b7280; margin-bottom: 20px; font-size: 0.9rem; }

        /* FILTER BOX STYLES */
        .filter-box { 
            background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; margin-bottom: 15px; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        .filter-row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        .btn-filter { background: #15803d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-clear { background: #9ca3af; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 5px; }
        
        .period-total { 
            text-align: center; font-size: 1.1rem; font-weight: bold; color: #15803d; 
            margin-bottom: 15px; padding: 10px; border-bottom: 2px dashed #eee; display: none;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #e5e7eb; padding: 10px; text-align: left; font-size: 0.85rem; color: #374151; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: top; }
        
        .amount { font-weight: bold; color: #10b981; }
        .codes-badge { background: #eff6ff; color: #1d4ed8; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-top: 2px; }
        
        .btn-action { border: none; background: none; cursor: pointer; font-size: 1.1rem; padding: 5px; opacity: 0.6; }
        .btn-action:hover { opacity: 1; transform: scale(1.1); }

        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 350px; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-save { background: #2563eb; color: white; }
        .btn-cancel { background: #e5e7eb; color: #374151; }

        .back-btn { display: block; width: 100%; padding: 12px; background: #4b5563; color: white; text-align: center; border: none; border-radius: 5px; margin-top: 20px; cursor: pointer; text-decoration: none; box-sizing: border-box; }
    </style>
    <script>if (!sessionStorage.getItem('isLoggedIn')) { window.location.href = 'login.html'; }</script>
</head>
<body>

    <div class="container">
        <h2 id="worker-name">Loading...</h2>
        <div class="subtitle">Work History & Filters</div>

        <div class="filter-box">
            <div class="filter-row">
                <select id="company-filter">
                    <option value="">-- All Companies --</option>
                </select>
            </div>
            <div class="filter-row">
                <input type="date" id="start-date">
                <span style="font-size:0.8rem; color:#666;">to</span>
                <input type="date" id="end-date">
            </div>
            <div class="filter-row">
                <button onclick="applyFilter()" class="btn-filter">üîé Apply Filter</button>
            </div>
            <button onclick="clearFilter()" class="btn-clear">Show All History</button>
        </div>

        <div id="filter-summary" class="period-total">
            Total for Selection: ‚Çπ<span id="p-total">0</span>
        </div>
        
        <div id="no-data" style="display:none; text-align:center; color:#999; margin:20px;">No work found.</div>

        <table>
            <thead>
                <tr>
                    <th style="width: 30%">Date/Co.</th>
                    <th style="width: 40%">Work</th>
                    <th style="width: 15%">Earned</th>
                    <th style="width: 15%">Action</th>
                </tr>
            </thead>
            <tbody id="history-list"></tbody>
        </table>

        <a href="index.html" class="back-btn">üîô Back to Dashboard</a>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>‚úèÔ∏è Edit Record</h3>
            <label>Company</label>
            <input type="text" id="edit-company" class="modal-input">
            <label>Work Codes</label>
            <input type="text" id="edit-codes" class="modal-input">
            <label>Price Amount (‚Çπ)</label>
            <input type="number" id="edit-amount" class="modal-input">
            <input type="hidden" id="edit-index"> 
            <button class="modal-btn btn-save" onclick="saveEdit()">üíæ Save Changes</button>
            <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, collection, getDocs } from './db.js';

        const urlParams = new URLSearchParams(window.location.search);
        const workerId = urlParams.get('id');

        let fullHistory = []; 
        let displayHistory = [];

        // 1. Load Data
        async function loadHistory() {
            if (!workerId) return;

            // Load Companies for Dropdown
            const compSelect = document.getElementById('company-filter');
            const compSnap = await getDocs(collection(db, "companies"));
            compSnap.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.data().name;
                opt.text = d.data().name;
                compSelect.appendChild(opt);
            });

            // Load Worker History
            try {
                const docRef = doc(db, "workers", workerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const worker = docSnap.data();
                    document.getElementById('worker-name').innerText = worker.name;
                    fullHistory = worker.history || [];
                    displayHistory = fullHistory;
                    renderTable(displayHistory);
                }
            } catch(e) { console.error(e); }
        }

        // 2. Render Table
        function renderTable(dataList) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            if (dataList.length === 0) {
                document.getElementById('no-data').style.display = 'block';
                return;
            } else {
                document.getElementById('no-data').style.display = 'none';
            }

            dataList.slice().reverse().forEach(log => {
                const originalIndex = fullHistory.indexOf(log); 
                const row = document.createElement('tr');
                const companyLabel = log.company ? `<div style="color:#2563eb; font-weight:bold; font-size:0.8rem;">üè¢ ${log.company}</div>` : "";

                row.innerHTML = `
                    <td style="font-size:0.85rem; color:#555;">
                        ${log.date.split(',')[0]}<br>
                        ${companyLabel}
                    </td>
                    <td><span class="codes-badge">${log.codes}</span></td>
                    <td class="amount">‚Çπ${log.amount}</td>
                    <td>
                        <button class="btn-action" onclick="window.openEdit(${originalIndex})">‚úèÔ∏è</button>
                        <button class="btn-action" style="color:red;" onclick="window.deleteItem(${originalIndex})">üóë</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        // 3. FILTER LOGIC (UPDATED WITH COMPANY)
        window.applyFilter = function() {
            const companyVal = document.getElementById('company-filter').value;
            const startVal = document.getElementById('start-date').value;
            const endVal = document.getElementById('end-date').value;

            // Filter logic
            const filtered = fullHistory.filter(log => {
                let matchesCompany = true;
                let matchesDate = true;

                // Check Company
                if (companyVal && log.company !== companyVal) {
                    matchesCompany = false;
                }

                // Check Date (Only if dates are selected)
                if (startVal && endVal) {
                    const logDate = new Date(log.date);
                    const startDate = new Date(startVal);
                    startDate.setHours(0,0,0,0);
                    const endDate = new Date(endVal);
                    endDate.setHours(23,59,59,999);
                    
                    if (logDate < startDate || logDate > endDate) {
                        matchesDate = false;
                    }
                }

                return matchesCompany && matchesDate;
            });

            // Calculate Total
            let periodTotal = 0;
            filtered.forEach(item => periodTotal += Number(item.amount));
            
            document.getElementById('p-total').innerText = periodTotal;
            document.getElementById('filter-summary').style.display = 'block';
            
            displayHistory = filtered;
            renderTable(displayHistory);
        }

        window.clearFilter = function() {
            document.getElementById('company-filter').value = '';
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('filter-summary').style.display = 'none';
            displayHistory = fullHistory;
            renderTable(displayHistory);
        }

        // 4. Delete & Edit (Same as before)
        window.deleteItem = async function(index) {
            if(!confirm("Are you sure? This will reduce Total Earnings.")) return;
            fullHistory.splice(index, 1);
            await updateCloud();
        }

        window.openEdit = function(index) {
            const item = fullHistory[index];
            document.getElementById('edit-company').value = item.company || "";
            document.getElementById('edit-codes').value = item.codes;
            document.getElementById('edit-amount').value = item.amount;
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        window.closeModal = function() { document.getElementById('edit-modal').style.display = 'none'; }

        window.saveEdit = async function() {
            const index = document.getElementById('edit-index').value;
            fullHistory[index].company = document.getElementById('edit-company').value;
            fullHistory[index].codes = document.getElementById('edit-codes').value;
            fullHistory[index].amount = Number(document.getElementById('edit-amount').value);
            await updateCloud();
            closeModal();
        }

        async function updateCloud() {
            let newTotal = 0;
            fullHistory.forEach(item => newTotal += Number(item.amount));
            try {
                await updateDoc(doc(db, "workers", workerId), { history: fullHistory, earnings: newTotal });
                alert("Saved!");
                window.applyFilter(); // Re-apply current filter
            } catch(e) { alert("Error: " + e.message); }
        }

        loadHistory();
    </script>
</body>
</html>